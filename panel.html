<script>
    // 1. Verificación inmediata: Si esto no sale en consola, el archivo está roto
    console.log("El panel se está cargando...");

    function mostrarMensaje(texto, color = "#2563eb") {
        if (typeof Toastify === "function") {
            Toastify({
                text: texto,
                duration: 3000,
                style: { background: color }
            }).showToast();
        } else {
            alert(texto);
        }
    }

    async function cargarTickets() {
        console.log("Intentando cargar tickets...");
        const tbody = document.getElementById('tabla-body');
        if (!tbody) return;

        try {
            // Consulta ultra simple para evitar errores
            const { data, error } = await _supabase
                .from('Tickets')
                .select('*');

            if (error) {
                console.error("Error de Supabase:", error);
                tbody.innerHTML = '<tr><td colspan="6">Error de permisos (SELECT).</td></tr>';
                return;
            }

            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6">No hay registros.</td></tr>';
                return;
            }

            let html = "";
            data.forEach(t => {
                html += `
                    <tr>
                        <td>#${t.id ? t.id.substring(0, 5) : '---'}</td>
                        <td>${t.patente || 'N/A'}</td>
                        <td>${t.zona || 'N/A'}</td>
                        <td>${t["tipo de consulta"] || 'N/A'}</td>
                        <td>${t.estado || 'Pendiente'}</td>
                        <td>${t.create_at ? new Date(t.create_at).toLocaleDateString() : '---'}</td>
                    </tr>`;
            });
            tbody.innerHTML = html;

        } catch (e) {
            console.error("Error crítico:", e);
            tbody.innerHTML = '<tr><td colspan="6">Error crítico en la carga.</td></tr>';
        }
    }

    async function crearTicket() {
        const patente = document.getElementById('patente').value;
        const desc = document.getElementById('descripcion').value;

        if(!patente || !desc) {
            mostrarMensaje("Completa los campos", "#ef4444");
            return;
        }

        const { error } = await _supabase.from('Tickets').insert([{
            creado_por: currentUserId,
            patente: patente.toUpperCase(),
            descripcion: desc,
            estado: 'Pendiente'
        }]);

        if (error) {
            mostrarMensaje("Error al guardar", "#ef4444");
        } else {
            mostrarMensaje("¡Guardado!");
            cargarTickets();
        }
    }
</script>
