<script>
    // Verificación en consola
    console.log("Panel de control activo");

    function mostrarMensaje(texto, color = "#2563eb") {
        if (typeof Toastify === "function") {
            Toastify({
                text: texto,
                duration: 3000,
                gravity: "top",
                position: "right",
                style: { background: color, borderRadius: "8px" }
            }).showToast();
        } else {
            alert(texto);
        }
    }

    async function cargarTickets() {
        console.log("Intentando cargar la lista...");
        const tbody = document.getElementById('tabla-body');
        if (!tbody) return;

        try {
            // Consulta básica. Si no hay política de SELECT, Supabase dará error 
            // pero el "try/catch" evitará que la pantalla se ponga blanca.
            const { data, error } = await _supabase
                .from('Tickets')
                .select('*')
                .order('create_at', { ascending: false });

            if (error) {
                console.warn("Aviso: No se pueden leer tickets aún (Falta política SELECT)");
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No tienes tickets registrados.</td></tr>';
                return;
            }

            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No tienes tickets registrados.</td></tr>';
                return;
            }

            let html = "";
            data.forEach(t => {
                const idCorto = t.id ? t.id.substring(0, 5) : '---';
                html += `
                    <tr>
                        <td><span class="ticket-id">#${idCorto}</span></td>
                        <td><strong>${t.patente || 'N/A'}</strong></td>
                        <td>${t.zona || 'N/A'}</td>
                        <td>${t["tipo de consulta"] || 'N/A'}</td>
                        <td><span class="status-badge">${t.estado || 'Pendiente'}</span></td>
                        <td>${t.create_at ? new Date(t.create_at).toLocaleDateString() : '---'}</td>
                    </tr>`;
            });
            tbody.innerHTML = html;

        } catch (e) {
            console.error("Error en la carga visual:", e);
        }
    }

    async function crearTicket() {
        // Obtenemos los elementos para poder limpiarlos después
        const patenteInput = document.getElementById('patente');
        const zonaInput = document.getElementById('zona');
        const tipoInput = document.getElementById('tipo_consulta_input');
        const descInput = document.getElementById('descripcion');
        const btn = document.getElementById('btn-crear');

        if(!patenteInput.value || !descInput.value) {
            mostrarMensaje("⚠️ Por favor completa los campos obligatorios", "#ef4444");
            return;
        }

        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerHTML = "Enviando...";

        const { error } = await _supabase.from('Tickets').insert([{
            creado_por: currentUserId,
            patente: patenteInput.value.toUpperCase(),
            zona: zonaInput.value ? zonaInput.value.toUpperCase() : 'NORTE',
            "tipo de consulta": tipoInput.value,
            descripcion: descInput.value,
            estado: 'Pendiente'
        }]);

        if (error) {
            mostrarMensaje("❌ Error al guardar: " + error.message, "#ef4444");
            btn.disabled = false;
            btn.innerText = originalText;
        } else {
            mostrarMensaje("✅ ¡Ticket registrado correctamente!");
            
            // Limpiar formulario
            patenteInput.value = '';
            descInput.value = '';
            
            btn.disabled = false;
            btn.innerText = originalText;
            
            // Refrescar vista
            setTimeout(() => {
                verSeccion('lista');
                cargarTickets();
            }, 500);
        }
    }
</script>
