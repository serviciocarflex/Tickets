<!DOCTYPE html>
<html>
<head>
    <title>Carflex - Mis Tickets</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f4f4; }
        .box { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #2563eb; color: white; }
        .btn { padding: 10px; cursor: pointer; background: #2563eb; color: white; border: none; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="box">
        <h2>Mis Tickets</h2>
        <button class="btn" onclick="location.href='nuevo.html'">+ Crear Ticket</button>
        <button onclick="cerrarSesion()" style="float:right">Cerrar Sesión</button>
        
        <table>
            <thead>
                <tr><th>Patente</th><th>Estado</th><th>Fecha</th></tr>
            </thead>
            <tbody id="lista"></tbody>
        </table>
    </div>

    <script>
        const _supabase = supabase.createClient('TU_URL', 'TU_KEY');

        async function inicio() {
            const { data: { session } } = await _supabase.auth.getSession();
            if (!session) { 
                window.location.href = 'index.html'; 
                return; 
            }
            
            // Cargar tickets del usuario
            const { data } = await _supabase.from('Tickets')
                .select('*')
                .eq('creado_por', session.user.id);
            
            const lista = document.getElementById('lista');
            if (!data || data.length === 0) {
                lista.innerHTML = '<tr><td colspan="3">No tienes tickets aún.</td></tr>';
            } else {
                lista.innerHTML = data.map(t => `
                    <tr>
                        <td>${t.patente}</td>
                        <td>${t.estado}</td>
                        <td>${new Date(t.create_at).toLocaleDateString()}</td>
                    </tr>`).join('');
            }
        }

        async function cerrarSesion() {
            await _supabase.auth.signOut();
            window.location.href = 'index.html';
        }

        inicio();
    </script>
</body>
</html>
