<!DOCTYPE html>
<html>
<head>
    <title>Carflex - Mis Tickets</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f4f4; }
        .box { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h2 { margin-top: 0; }
        .btn-crear { padding: 10px 15px; background: #2563eb; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; text-decoration: none; display: inline-block; margin-bottom: 20px; }
        .btn-cerrar { float: right; padding: 5px 10px; background: white; border: 1px solid #ccc; cursor: pointer; border-radius: 4px; }
        
        table { width: 100%; border-collapse: collapse; background: white; }
        th { background: #2563eb; color: white; padding: 12px; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        .status-badge { background: #e0e7ff; color: #4338ca; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; font-weight: bold; }
    </style>
</head>
<body>

<div class="box">
    <button class="btn-cerrar" onclick="cerrarSesion()">Cerrar Sesión</button>
    <h2>Mis Tickets</h2>
    
    <a href="nuevo.html" class="btn-crear">+ Crear Ticket</a>
    
    <table>
        <thead>
            <tr>
                <th>Patente</th>
                <th>Estado</th>
                <th>Fecha</th>
            </tr>
        </thead>
        <tbody id="tabla-tickets">
            <tr><td colspan="3" style="text-align:center;">Cargando tus registros...</td></tr>
        </tbody>
    </table>
</div>

<script>
    // Reemplaza con tus llaves reales
    const _supabase = supabase.createClient('TU_URL', 'TU_KEY');

    async function cargarTickets() {
        const tbody = document.getElementById('tabla-tickets');
        
        // 1. Verificamos quién eres
        const { data: { session } } = await _supabase.auth.getSession();
        
        if (!session) {
            window.location.href = 'index.html';
            return;
        }

        // 2. Traemos solo TUS tickets (gracias a la política que pusiste en el SQL Editor)
        const { data, error } = await _supabase
            .from('Tickets')
            .select('*')
            .eq('creado_por', session.user.id)
            .order('create_at', { ascending: false });

        if (error) {
            console.error("Error:", error);
            tbody.innerHTML = '<tr><td colspan="3">Error al cargar datos.</td></tr>';
            return;
        }

        // 3. Llenamos la tabla
        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">No tienes tickets registrados aún.</td></tr>';
        } else {
            tbody.innerHTML = data.map(t => `
                <tr>
                    <td><strong>${t.patente}</strong></td>
                    <td><span class="status-badge">${t.estado || 'Pendiente'}</span></td>
                    <td>${new Date(t.create_at).toLocaleDateString()}</td>
                </tr>
            `).join('');
        }
    }

    async function cerrarSesion() {
        await _supabase.auth.signOut();
        window.location.href = 'index.html';
    }

    // Ejecutar al cargar la página
    cargarTickets();
</script>
</body>
</html>
